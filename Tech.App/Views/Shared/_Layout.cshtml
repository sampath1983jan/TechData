@using CustomAuthentication
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <title>@ViewBag.Title</title>
    @Styles.Render("~/Content/css")
    @Styles.Render("~/Content/appstyle")
    @Scripts.Render("~/bundles/modernizr")
    @Scripts.Render("~/bundles/jquery")
    @Scripts.Render("~/bundles/jqueryui")
    @Scripts.Render("~/bundles/bootstrap")
    @Scripts.Render("~/bundles/controljs")
    
    @*<script src="~/Scripts/WebChat.js"></script>*@
    @RenderSection("scripts", required: false)
    <link href="https://cdn.botframework.com/botframework-webchat/latest/botchat.css" rel="stylesheet" />
</head>
<body>
    <div class="navbar navbar-inverse navbar-fixed-top"></div>

    <div id="header_container">
        <div id="header">
            @*<i>=(^.^)= @ViewBag.Title</i>*@
            <span style="float:right; font-size:small">

                @if (HttpContext.Current.User.Identity.IsAuthenticated)
                {
                    var identity = ((CustomPrincipal)HttpContext.Current.User);
                    @:<nav id="navHeader" class="navbar navbar-expand-lg navbar-light bg-light">
                        @:<div class="navbar-collapse">
                            @:<ul class="navbar-nav">
                                @:<li class="nav-item active"><a class="nav-link " href="/Home/Index">Home</a></li>
                                @:<li class="nav-item"><a class="nav-link" href="/Schema/Schema">Schema</a></li>
                                @:<li class="nav-item"><a class="nav-link" href="/Server/Server">Server</a></li>
                                @:<li class="nav-item "><a class="nav-link" href="/Client/Client">Client</a></li>
                                @:<li class="nav-item "><a class="nav-link" href="/Schema/DataScript">Data Script</a></li>
                                @:<li class="nav-item"><a class="nav-link" href="/Authentication/LogOut">Log out</a></li>
                                @:<li class="nav-item"><a class="nav-link" href="/Authentication/LogOut">@Html.Label(string.Format("{0} {1}", identity.FirstName, identity.LastName))</a></li>
                            @:</ul>
                        @:</div>
                    @:</nav>




                    @*@Html.ActionLink("Home", "Index", "Home");
                        @Html.ActionLink("Schema", "Schema", "Schema");
                        @Html.ActionLink("Server", "Server", "Server");
                        @Html.ActionLink("Clients", "Client", "Client");
                        @Html.ActionLink("Log out", "LogOut", "Authentication")*@
                    //@Html.Label(string.Format("Welcome {0} {1}", identity.FirstName, identity.LastName))

                }
            </span>
        </div>
    </div>

    <div class="body-content">
        @RenderBody()
        <hr />



        <footer>
            <p>&copy; @DateTime.Now.Year</p>
        </footer>
    </div>

   


    <script type="text/javascript">
        var table = "";
        var currentPage = 0;
        var tbList = [];
        var clientid = "";
        $(document).ready(function () {
            $("#navHeader").find("a").click(function () {
                $("#navHeader").find("li").removeClass("active");
                $(this).parent().addClass("active");
            });


            function bindTables(data) {
                $("#tblist").html("");
                $.each(data, function (i, d) {
                    $("#tblist").append("<div class='row mar'><div class='col-md-12'><a style='cursor:pointer' t='" + d.Name + "'>" + d.Name + "</a></div></div>");
                })
                $("#tblist a").click(function () {
                    var name = $(this).attr("t");
                    tbName = name;
                    getField(name);
                })
            }
            renderClients = function () {
                //    function loadClients() {
                $.ajax('/Client/Gets',
                    {
                        type: "GET",
                        dataType: 'jsonp', // type of response data
                        data: "",
                        // timeout milliseconds
                        success: function (data, status, xhr) {   // success callback function
                            $("#clientlist").html("");
                            var dv = "<div class='row'>"
                            $.each(data, function (i, d) {
                                dv = dv + "<div class='col-md-12'><a href='#' name='" + d.ClientID + "'>" + d.OrganizationName + "-" + d.ClientName + "-" + d.ClientNo + "</a></div>";
                            })
                            dv = dv + "</div>"
                            $("#clientlist").append(dv);
                            $("#clientlist").find("a").click(function () {
                                clientid = $(this).attr("name");
                                renderTables();
                            })
                        },
                        error: function (jqXhr, textStatus, errorMessage) { // error callback
                            alert(errorMessage);
                            //$('p').append('Error: ' + errorMessage);
                        }
                    });
                // }
            }
            renderTables = function () {

                $.ajax({
                    type: "POST",
                    url: "/Home/GetEntity",
                    data: JSON.stringify({ clientid: clientid }),
                    dataType: "json",
                    contentType: 'application/json; charset=utf-8',
                    success: function (data) {
                        data = JSON.parse(data);
                        tbList = data;
                        bindTables(data);
                    },
                    error: function () {
                        alert("Error occured!!")
                    }
                });
            }

            $("#txtSearch").keyup(function () {
                var val = $(this).val();
                if (val == "") {
                    newdataset = tbList;
                } else {
                    var newdataset = $.grep(tbList, function (v) {
                        return v.Name.indexOf(val) == 0;
                    });
                }
                bindTables(newdataset);
            });

            function renderGrid() {
                $.ajax({
                    type: "POST",
                    url: "/Home/GetData",
                    data: JSON.stringify({ tb: tbName, currentPage: currentPage, PageSize: 10, clientid: clientid }),
                    dataType: "json",
                    contentType: 'application/json; charset=utf-8',
                    success: function (data) {
                        $("#txtPageNo").val(currentPage);
                        data = JSON.parse(data);
                        Page = data.Page;
                        data = data.Data;
                        var keys = [];
                        if (data.length > 0) {
                            for (var key in data[0]) {
                                keys.push(key);
                            }
                        }
                        $("#datalist").html("");

                        //datalist


                        str = "<table style='width:100%'>"
                        str = str + "<tr>";
                        $.each(keys, function (ir, r) {

                            str = str + "<td>" + r + "</td>";

                        });
                        str = str + "</tr>";
                        $.each(data, function (ir, r) {
                            str = str + "<tr>";
                            $.each(keys, function (ic, c) {
                                str = str + "<td>" + r[c] + "</td>";
                            })
                            str = str + "</tr>";
                        });
                        str = str + "</table>";
                        $("#datalist").append(str);
                        $("#ttrc").html("<h3> Total Record in this table:" + Page.TotalRecord + "</h3>");

                        //data = data.Columns;
                        //$.each(data, function (i, d) {
                        //    $("#fields").append("<div class='row mar'><div class='col-md-6'>" + d.Name + "</div><div class='col-md-2'>" + d.NativeType + "</div><div class='col-md-2'>" + d.Size + "</div><div class='col-md-2'>" + d.PrimaryKey + "</div></div>");
                        //})
                    },
                    error: function () {
                        alert("Error occured!!")
                    }
                });
            }
            $("#showdata").click(function () {
                $("#txtPageNo").blur(function () {
                    var v = $(this).val();
                    if (v != "") {
                        currentPage = v;
                    }
                    renderGrid();
                })
                renderGrid();

                //$("#nCard").modalwindow({ id: 'win' });
                //$("#nCard").modalwindow('open');

            })
            function getField(tbName) {
                $.ajax({
                    type: "POST",
                    url: "/Home/GetFields",
                    data: JSON.stringify({ tb: tbName, clientid: clientid }),
                    dataType: "json",
                    contentType: 'application/json; charset=utf-8',
                    success: function (data) {
                        $("#fields").html("");
                        $("#txtPageNo").val(0);
                        data = JSON.parse(data);
                        data = data.Columns;
                        $.each(data, function (i, d) {
                            $("#fields").append("<div class='row mar'><div class='col-md-6'>" + d.Name + "</div><div class='col-md-2'>" + d.NativeType + "</div><div class='col-md-2'>" + d.Size + "</div><div class='col-md-2'>" + d.PrimaryKey + "</div></div>");
                        })

                    },
                    error: function () {
                        alert("Error occured!!")
                    }
                });
            }
            renderClients();

      

            //window.WebChat.renderWebChat({
            //            directLine: window.WebChat.createDirectLine({
            //                token: "y0qs3BIyoLE.CRrz91tTYwaror0MIJbaqZEe7OxoGmGjyZUvShqBQdQ"
            //            }), userID: 'YOUR_USER_ID',
            //    username: 'Web Chat User',
            //    locale: 'en-US',
            //    botAvatarInitials: 'WC',
            //    userAvatarInitials: 'WW'
            //}, document.getElementById('webchat'));


            //window.fetch('https://elizaadevt.azurewebsites.net/directline/token', { method: 'POST' })
            //    .then(function (res) {
            //        return res.json();
            //    })
            //    .then(function (json) {
            //        const token = json.token;
            //        window.WebChat.renderWebChat({
            //            directLine: window.WebChat.createDirectLine({
            //                token: token
            //            })
            //        }, document.getElementById('webchat'));
            //        document.querySelector('#webchat > *').focus();
            //    });

            //(async function () {
            //    // In this demo, we are using Direct Line token from MockBot.
            //    // To talk to your bot, you should use the token exchanged using your Direct Line secret.
            //    // You should never put the Direct Line secret in the browser or client app.
            //    // https://docs.microsoft.com/en-us/azure/bot-service/rest-api/bot-framework-rest-direct-line-3-0-authentication

            //    const res = await fetch('https://elizaadevt.azurewebsites.net/directline/token', { method: 'POST' });
            //    const { token } = await res.json();

            //    window.WebChat.renderWebChat({
            //        directLine: window.WebChat.createDirectLine({ token })
            //    }, document.getElementById('webchat'));

            //    document.querySelector('#webchat > *').focus();
            //})().catch(err => console.error(err));

            //$("#nCard").namecard({
            //    title: "personal information",
            //    header: "Employee ",
            //    bodyTemplate: 'Some quick example text to build on the card title and make up the bulk of the card`s content',
            //    image: '', //'https://www.planwallpaper.com/static/images/adirondacks-sun-beams-640x300.jpg',
            //    imagePosition: 'bottom',
            //    footerTemplate: '<small class="text-muted">welcome to name card <a href="#" class="card-link">Go somewhere</a></small>',
            //    theme: "",
            //    align: 'left'
            //})



        });

    </script>
</body>
</html>
